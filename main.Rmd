---
title: "readme"
author: "Benjamin"
date: '2019-04-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse, glue, rlang, furrr, rvest)

source("R/run_as_long_as.R")
source("R/vpn_helpers.R")
source("R/openvpn_general.R")

devtools::load_all()

```

This package aims at providing an interface to handle vpn connexion from R.
It proposes wrapper for openvpn connexion and specifically for : 
+ Vpn server offered by vpngate
+ Any VPN set up with Tunnelblick
+ Hide My Ass Services
+ VPN Tunnels powered by cisco. 

So far, it only works on mac OS. 

# Installation

## Installing Openvpn
Before using hideR, you need to make sure that openvpn is install. 
To install it, run

```{bash}
brew update
brew install openvpn
```

Make sure that openvpn is well installed by typing in Terminal.

```{bash}
openvpn --help
```

If a long list of potential argumets appears, then it is good installed. If you get an error saying ("openvpn: command not found"), please run: 

```{bash}
export PATH=$(brew --prefix openvpn)/sbin:$PATH
```

## Installing hideR

To install hideR, please run : 
```{r}
devtools::install_github("benjaminguinaudeau/bashR")
devtools::install_github("benjaminguinaudeau/hideR")

bashR::sudo("ls", intern = T)
```

# Openvpn

## VPN with config file 

### General Connexion

The most common way, to connect to a OpenVPN tunnel is to use a config file (usually ending with .ovpn). If you have a config file, then you can simply run : 

```{r}
config_path <- "path/to/my/config/file"

#config_path <- "~/.vpn/utorvpn.ovpn"

# Initialize Connection according to configuration path
vpn <- vpn_tunnel$new(config_path = config_path)

# For many VPN, no authorentifications is required
vpn$connect(authentification = F, quiet = F)

# You can access some detils about vpn
vpn$status
vpn$id
vpn$ip
vpn$running_time()

# At any point, you can check your IP address using
get_current_ip()

# Once you done, disconnect the VPN Tunnel with
openvpn_disconnect()
```

### Case where username and password are needed

Some VPN connexion requires password authentification. To do so, a line in the config file has to point toward a local txt file containing username and password. 

The following function adds this line and create the txt file containing the username and the password in the same directory as the config_file. Please note here that this txt file can be red by anybody, who has access to the directory where your config_file is located. So, choose well this directory.


```{r}
# Error to detect
#Exiting due to fatal error

# If you're vpn requires authentification: type the username and password
vpn$connect(authentification = T, quiet = F)

# If you registered a wrong password and you want to replace it
vpn$connect(authentification = T, prune_password = T, quiet = T)
```

## Saving VPN-Connections so that you can restart it later 

```{r}

# If you want to keep the connexion initialized for further use, save the object
vpn$save()

# To get a list of all your saved connexions
list_all_connections()

# If you want to load an saved connexion, give its id
vpn <- get_connection(id = "utorvpn")
# Then you can connect the new tunnel
vpn$connect(authentification = T, quiet = F)
vpn$disconnect()

```

# Importing config file from Tunnelblick

If you have been using Tunnelblick vor your vpn connexion, you can also get direct access to the configuration informations. To do so, you can access to the config file in Tunnelblick through (Configuration, Choose the vpn you want to know the config file, Click on the Gear Icon, Modify Config File). 

Once you have the Config File, you can use copy the content and generate a config file using 

```{r}
configurations <- '###############################################################################
# OpenVPN 2.0 Sample Configuration File
# for PacketiX VPN / SoftEther VPN Server
# 
# !!! AUTO-GENERATED BY SOFTETHER VPN SERVER MANAGEMENT TOOL !!!
# 
# !!! YOU HAVE TO REVIEW IT BEFORE USE AND MODIFY IT AS NECESSARY !!!
# 
# This configuration file is auto-generated. You might use this config file
# in order to connect to the PacketiX VPN / SoftEther VPN Server.
# However, before you try it, you should review the descriptions of the file
# to determine the necessity to modify to suitable for your real environment.
# If necessary, you have to modify a little adequately on the file.
# For example, the IP address or the hostname as a destination VPN Server
# should be confirmed.
# 
# Note that to use OpenVPN 2.0, you have to put the certification file of
# the destination VPN Server on the OpenVPN Client computer when you use this
# config file. Please refer the below descriptions carefully.


###############################################################################
# Specify the type of the layer of the VPN connection.
# 
# To connect to the VPN Server as a "Remote-Access VPN Client PC",
#  specify \'dev tun\'. (Layer-3 IP Routing Mode)
#
# To connect to the VPN Server as a bridging equipment of "Site-to-Site VPN",
#  specify \'dev tap\'. (Layer-2 Ethernet Bridgine Mode)

dev tun


###############################################################################
# Specify the underlying protocol beyond the Internet.
# Note that this setting must be correspond with the listening setting on
# the VPN Server.
# 
# Specify either \'proto tcp\' or \'proto udp\'.

proto udp


###############################################################################
# The destination hostname / IP address, and port number of
# the target VPN Server.
# 
# You have to specify as \'remote <HOSTNAME> <PORT>\'. You can also
# specify the IP address instead of the hostname.
# 
# Note that the auto-generated below hostname are a "auto-detected
# IP address" of the VPN Server. You have to confirm the correctness
# beforehand.
# 
# When you want to connect to the VPN Server by using TCP protocol,
# the port number of the destination TCP port should be same as one of
# the available TCP listeners on the VPN Server.
# 
# When you use UDP protocol, the port number must same as the configuration
# setting of "OpenVPN Server Compatible Function" on the VPN Server.

remote vpn674350142.opengw.net 1459


###############################################################################
# The HTTP/HTTPS proxy setting.
# 
# Only if you have to use the Internet via a proxy, uncomment the below
# two lines and specify the proxy address and the port number.
# In the case of using proxy-authentication, refer the OpenVPN manual.

;http-proxy-retry
;http-proxy [proxy server] [proxy port]


###############################################################################
# The encryption and authentication algorithm.
# 
# Default setting is good. Modify it as you prefer.
# When you specify an unsupported algorithm, the error will occur.
# 
# The supported algorithms are as follows:
#  cipher: [NULL-CIPHER] NULL AES-128-CBC AES-192-CBC AES-256-CBC BF-CBC
#          CAST-CBC CAST5-CBC DES-CBC DES-EDE-CBC DES-EDE3-CBC DESX-CBC
#          RC2-40-CBC RC2-64-CBC RC2-CBC
#  auth:   SHA SHA1 MD5 MD4 RMD160

cipher AES-128-CBC
auth SHA1


###############################################################################
# Other parameters necessary to connect to the VPN Server.
# 
# It is not recommended to modify it unless you have a particular need.

resolv-retry infinite
nobind
persist-key
persist-tun
client
verb 3
#auth-user-pass


###############################################################################
# The certificate file of the destination VPN Server.
# 
# The CA certificate file is embedded in the inline format.
# You can replace this CA contents if necessary.
# Please note that if the server certificate is not a self-signed, you have to
# specify the signer\'s root certificate (CA) here.

<ca>
-----BEGIN CERTIFICATE-----
MIIF2DCCA8CgAwIBAgIQTKr5yttjb+Af907YWwOGnTANBgkqhkiG9w0BAQwFADCB
hTELMAkGA1UEBhMCR0IxGzAZBgNVBAgTEkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4G
A1UEBxMHU2FsZm9yZDEaMBgGA1UEChMRQ09NT0RPIENBIExpbWl0ZWQxKzApBgNV
BAMTIkNPTU9ETyBSU0EgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkwHhcNMTAwMTE5
MDAwMDAwWhcNMzgwMTE4MjM1OTU5WjCBhTELMAkGA1UEBhMCR0IxGzAZBgNVBAgT
EkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4GA1UEBxMHU2FsZm9yZDEaMBgGA1UEChMR
Q09NT0RPIENBIExpbWl0ZWQxKzApBgNVBAMTIkNPTU9ETyBSU0EgQ2VydGlmaWNh
dGlvbiBBdXRob3JpdHkwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCR
6FSS0gpWsawNJN3Fz0RndJkrN6N9I3AAcbxT38T6KhKPS38QVr2fcHK3YX/JSw8X
pz3jsARh7v8Rl8f0hj4K+j5c+ZPmNHrZFGvnnLOFoIJ6dq9xkNfs/Q36nGz637CC
9BR++b7Epi9Pf5l/tfxnQ3K9DADWietrLNPtj5gcFKt+5eNu/Nio5JIk2kNrYrhV
/erBvGy2i/MOjZrkm2xpmfh4SDBF1a3hDTxFYPwyllEnvGfDyi62a+pGx8cgoLEf
Zd5ICLqkTqnyg0Y3hOvozIFIQ2dOciqbXL1MGyiKXCJ7tKuY2e7gUYPDCUZObT6Z
+pUX2nwzV0E8jVHtC7ZcryxjGt9XyD+86V3Em69FmeKjWiS0uqlWPc9vqv9JWL7w
qP/0uK3pN/u6uPQLOvnoQ0IeidiEyxPx2bvhiWC4jChWrBQdnArncevPDt09qZah
SL0896+1DSJMwBGB7FY79tOi4lu3sgQiUpWAk2nojkxl8ZEDLXB0AuqLZxUpaVIC
u9ffUGpVRr+goyhhf3DQw6KqLCGqR84onAZFdr+CGCe01a60y1Dma/RMhnEw6abf
Fobg2P9A3fvQQoh/ozM6LlweQRGBY84YcWsr7KaKtzFcOmpH4MN5WdYgGq/yapiq
crxXStJLnbsQ/LBMQeXtHT1eKJ2czL+zUdqnR+WEUwIDAQABo0IwQDAdBgNVHQ4E
FgQUu69+Aj36pvE8hI6t7jiY7NkyMtQwDgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB
/wQFMAMBAf8wDQYJKoZIhvcNAQEMBQADggIBAArx1UaEt65Ru2yyTUEUAJNMnMvl
wFTPoCWOAvn9sKIN9SCYPBMtrFaisNZ+EZLpLrqeLppysb0ZRGxhNaKatBYSaVqM
4dc+pBroLwP0rmEdEBsqpIt6xf4FpuHA1sj+nq6PK7o9mfjYcwlYRm6mnPTXJ9OV
2jeDchzTc+CiR5kDOF3VSXkAKRzH7JsgHAckaVd4sjn8OoSgtZx8jb8uk2Intzna
FxiuvTwJaP+EmzzV1gsD41eeFPfR60/IvYcjt7ZJQ3mFXLrrkguhxuhoqEwWsRqZ
CuhTLJK7oQkYdQxlqHvLI7cawiiFwxv/0Cti76R7CZGYZ4wUAc1oBmpjIXUDgIiK
boHGhfKppC3n9KUkEEeDys30jXlYsQab5xoq2Z0B15R97QNKyvDb6KkBPvVWmcke
jkk9u+UJueBPSZI9FoJAzMxZxuY67RIuaTxslbH9qh17f4a+Hg4yRvv7E491f0yL
S0Zj/gA0QHDBw7mh3aZw4gSzQbzpgJHqZJx64SIDqZxubw5lT2yHh17zbqD5daWb
QOhTsiedSrnAdyGN/4fy3ryM7xfft0kL0fJuMAsaDk527RH89elWsn2/x20Kk4yl
0MC2Hb46TpSi125sC8KKfPog88Tk5c0NqMuRkrF8hey1FGlmDoLnzc7ILaZRfyHB
NVOFBkpdn627G190
-----END CERTIFICATE-----

</ca>


###############################################################################
# The client certificate file (dummy).
# 
# In some implementations of OpenVPN Client software
# (for example: OpenVPN Client for iOS),
# a pair of client certificate and private key must be included on the
# configuration file due to the limitation of the client.
# So this sample configuration file has a dummy pair of client certificate
# and private key as follows.

<cert>
-----BEGIN CERTIFICATE-----
MIICxjCCAa4CAQAwDQYJKoZIhvcNAQEFBQAwKTEaMBgGA1UEAxMRVlBOR2F0ZUNs
aWVudENlcnQxCzAJBgNVBAYTAkpQMB4XDTEzMDIxMTAzNDk0OVoXDTM3MDExOTAz
MTQwN1owKTEaMBgGA1UEAxMRVlBOR2F0ZUNsaWVudENlcnQxCzAJBgNVBAYTAkpQ
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5h2lgQQYUjwoKYJbzVZA
5VcIGd5otPc/qZRMt0KItCFA0s9RwReNVa9fDRFLRBhcITOlv3FBcW3E8h1Us7RD
4W8GmJe8zapJnLsD39OSMRCzZJnczW4OCH1PZRZWKqDtjlNca9AF8a65jTmlDxCQ
CjntLIWk5OLLVkFt9/tScc1GDtci55ofhaNAYMPiH7V8+1g66pGHXAoWK6AQVH67
XCKJnGB5nlQ+HsMYPV/O49Ld91ZN/2tHkcaLLyNtywxVPRSsRh480jju0fcCsv6h
p/0yXnTB//mWutBGpdUlIbwiITbAmrsbYnjigRvnPqX1RNJUbi9Fp6C2c/HIFJGD
ywIDAQABMA0GCSqGSIb3DQEBBQUAA4IBAQChO5hgcw/4oWfoEFLu9kBa1B//kxH8
hQkChVNn8BRC7Y0URQitPl3DKEed9URBDdg2KOAz77bb6ENPiliD+a38UJHIRMqe
UBHhllOHIzvDhHFbaovALBQceeBzdkQxsKQESKmQmR832950UCovoyRB61UyAV7h
+mZhYPGRKXKSJI6s0Egg/Cri+Cwk4bjJfrb5hVse11yh4D9MHhwSfCOH+0z4hPUT
Fku7dGavURO5SVxMn/sL6En5D+oSeXkadHpDs+Airym2YHh15h0+jPSOoR6yiVp/
6zZeZkrN43kuS73KpKDFjfFPh8t4r1gOIjttkNcQqBccusnplQ7HJpsk
-----END CERTIFICATE-----

</cert>

<key>
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA5h2lgQQYUjwoKYJbzVZA5VcIGd5otPc/qZRMt0KItCFA0s9R
wReNVa9fDRFLRBhcITOlv3FBcW3E8h1Us7RD4W8GmJe8zapJnLsD39OSMRCzZJnc
zW4OCH1PZRZWKqDtjlNca9AF8a65jTmlDxCQCjntLIWk5OLLVkFt9/tScc1GDtci
55ofhaNAYMPiH7V8+1g66pGHXAoWK6AQVH67XCKJnGB5nlQ+HsMYPV/O49Ld91ZN
/2tHkcaLLyNtywxVPRSsRh480jju0fcCsv6hp/0yXnTB//mWutBGpdUlIbwiITbA
mrsbYnjigRvnPqX1RNJUbi9Fp6C2c/HIFJGDywIDAQABAoIBAERV7X5AvxA8uRiK
k8SIpsD0dX1pJOMIwakUVyvc4EfN0DhKRNb4rYoSiEGTLyzLpyBc/A28Dlkm5eOY
fjzXfYkGtYi/Ftxkg3O9vcrMQ4+6i+uGHaIL2rL+s4MrfO8v1xv6+Wky33EEGCou
QiwVGRFQXnRoQ62NBCFbUNLhmXwdj1akZzLU4p5R4zA3QhdxwEIatVLt0+7owLQ3
lP8sfXhppPOXjTqMD4QkYwzPAa8/zF7acn4kryrUP7Q6PAfd0zEVqNy9ZCZ9ffho
zXedFj486IFoc5gnTp2N6jsnVj4LCGIhlVHlYGozKKFqJcQVGsHCqq1oz2zjW6LS
oRYIHgECgYEA8zZrkCwNYSXJuODJ3m/hOLVxcxgJuwXoiErWd0E42vPanjjVMhnt
KY5l8qGMJ6FhK9LYx2qCrf/E0XtUAZ2wVq3ORTyGnsMWre9tLYs55X+ZN10Tc75z
4hacbU0hqKN1HiDmsMRY3/2NaZHoy7MKnwJJBaG48l9CCTlVwMHocIECgYEA8jby
dGjxTH+6XHWNizb5SRbZxAnyEeJeRwTMh0gGzwGPpH/sZYGzyu0SySXWCnZh3Rgq
5uLlNxtrXrljZlyi2nQdQgsq2YrWUs0+zgU+22uQsZpSAftmhVrtvet6MjVjbByY
DADciEVUdJYIXk+qnFUJyeroLIkTj7WYKZ6RjksCgYBoCFIwRDeg42oK89RFmnOr
LymNAq4+2oMhsWlVb4ejWIWeAk9nc+GXUfrXszRhS01mUnU5r5ygUvRcarV/T3U7
TnMZ+I7Y4DgWRIDd51znhxIBtYV5j/C/t85HjqOkH+8b6RTkbchaX3mau7fpUfds
Fq0nhIq42fhEO8srfYYwgQKBgQCyhi1N/8taRwpk+3/IDEzQwjbfdzUkWWSDk9Xs
H/pkuRHWfTMP3flWqEYgW/LW40peW2HDq5imdV8+AgZxe/XMbaji9Lgwf1RY005n
KxaZQz7yqHupWlLGF68DPHxkZVVSagDnV/sztWX6SFsCqFVnxIXifXGC4cW5Nm9g
va8q4QKBgQCEhLVeUfdwKvkZ94g/GFz731Z2hrdVhgMZaU/u6t0V95+YezPNCQZB
wmE9Mmlbq1emDeROivjCfoGhR3kZXW1pTKlLh6ZMUQUOpptdXva8XxfoqQwa3enA
M7muBbF0XN7VO80iJPv+PmIZdEIAkpwKfi201YB+BafCIuGxIF50Vg==
-----END RSA PRIVATE KEY-----

</key>'
```


```{r}
configurations <- "This is a very long string giving the content of the config files copied from Tunelblick
dev tun
proto udp
topology subnet
verb 3"

configurations <- rstudioapi::showPrompt("Config File", "Please Paste your Config File")

configurations %>%
  str_detect("\n")

vpn <- vpn_tunnel$new(config_file = str_split(configurations, "\n")[[1]])

vpn$connect(quiet = F)

openvpn_disconnect()

```

# Cisco Functions

Many VPN prefers to use cisco products. In this case, you'll need to authentificate. The procedure is the same.

```{r}
vpn_cisco <- vpn_tunnel$new(type = "cisco")
vpn_cisco$connect()

vpn_cisco["private"]

vpn_cisco$disconnect()
```


# VPN Gate

If you want to spare the time looking for a config file, you can also rely on the database proposed by vpngate

```{r}
servers <- vpngate_update_list()

servers %>%
  count(country_long, sort = T)

vpn_brazil <- vpngate_select(servers, c("country_long" = "Brazil"))
vpn_brazil$connect(quiet = F)

servers %>%
  arrange(-speed)

fastest_server <-  servers %>%
  arrange(-speed) %>%
  slice(2)

vpngate_fast <- vpngate_select(servers, c('ip' = fastest_server$ip))
vpngate_fast$connect(quiet = F)



```



# Using Hide My Ass with R




# Cisco Connexion 

# To do

+ unit testing for run_as_long_as
+ solve the gathering of the vpngate servers
+ add Cisco

# Create connexion profil

# Connect given connexion profil

```{r}
#devtools::install_github("ropensci/agent")
pacman::p_load(tidyverse, rvest, glue, furrr, agent)

plan(multiprocess, workers = 2)




# get_openvpn_config_link <- function(node){
#   node %>%
#     xml_parents() %>%
#     map_chr(html_attr, "href") %>%
#     discard(is.na)
# }

disconnect <- function(n = 1){
  system("sudo killall openvpn", 
         ignore.stderr = T,
         ignore.stdout = T, 
         intern = F,)
  while(n != 1){
    Sys.sleep(1)
    n <- n - 1
  }
}

prune_config_files <- function(){
  fs::dir_ls("./config") %>%
    walk(~fs::file_delete(.x))
}


```

## Update Server List

```{r}
mirror_links <- read_html("https://www.vpngate.net/en/sites.aspx")


update_server_list <- function(){
  message("This might takes a few seconds...")
  
  # Updating csv file
  if(fs::file_exists("./config/meta_data.txt")){
    fs::file_delete("./config/meta_data.txt")
  }  
  
  run_as_long_as(
    expr = download.file("https://www.vpngate.net/api/iphone/", "./config/meta_data.txt"), 
    output_cond = fs::file_exists("./config/meta_data.txt"), 
    max_iter = 5, 
    time_out = 20, 
    quiet = F
  )
  
  data <- read_csv("./config/meta_data.txt", skip = 1) %>%
    janitor::clean_names()
  
  server_list <- data %>%
    mutate(config_string = open_vpn_config_data_base64 %>%
             map(base64enc::base64decode) %>%
             map_chr(rawToChar))
  
  
  # 
  # message("Metadata downloaded (Step 1)")
  # 
  # # Updating config file
  # home_page <- run_as_long_as(
  #   expr = read_html("https://www.vpngate.net/en/"), 
  #   max_iter = 5, 
  #   time_out = 15
  # )
  # 
  # # home_page <- "" 
  # # class(home_page) <- "try-error"
  # # 
  # # while(class(home_page)[1] == "try-error"){
  # #   message("Gathering Table...")
  # #   home_page <- try({
  # #     "https://www.vpngate.net/en/" %>%
  # #       read_html()
  # #   })
  # # }
  # 
  # config_links <- home_page %>%
  #   html_nodes("tr") %>%
  #   future_map(~{
  #     ip <- .x %>% 
  #       html_nodes("td:nth-child(2) span:nth-child(3)") %>%
  #       map_chr(html_text)
  #     
  #     if(length(ip) > 1) return(NULL)
  #     if(length(ip) == 0) return(NULL)
  #     
  #     config_link <- .x %>% 
  #       html_nodes("td:nth-child(7) a b") %>%
  #       map_chr(get_openvpn_config_link) %>%
  #       paste0("https://www.vpngate.net/en/", .)
  #     #if(is.n)
  #     
  #     return(tibble(config_link, ip))
  #   }, .progress = T) %>%
  #   discard(is.null) %>%
  #   reduce(bind_rows)
  # 
  # message("Links of config_file gathered (Step 2)")
  # 
  # server_list <- data %>%
  #   left_join(config_links, by = "ip")
  
  return(server_list)
}

server_list_ <- update_server_list()
server_list
```

## Get config file

```{r}

server <- server_list %>%
  sample_n(1)

get_config_path <- function(name) paste0("./config/", name, ".ovpn")

generate_config_file <- function(server){
  config_file <- get_config_path(server$number_host_name)
  
  write_lines(server$config_string, config_file)
}
```



```{r}

openvpn_config <- function(server, intern = T){ 
  disconnect(2)
  
  config_path <- get_config_path(server$number_host_name)
  
  if(!fs::file_exists(config_path)) stop("No config file, please run 'get_config(server)'")
  
  current_ip <- get_current_ip()
  message(glue("Current IP: { current_ip }"))
  
  system(paste0("sudo /usr/local/sbin/openvpn --config ", config_path), 
         ignore.stdout = F, ignore.stderr = F, intern = intern, wait = F)
  
  run_as_long_as(
    expr = {cat(".") ; Sys.sleep(1)}, 
    output_cond = current_ip != get_current_ip(),
    max_iter = 30
  )
  
  # trig <- 1
  # new_ip <- get_current_ip()
  # while(!(trig >= 10 | current_ip != new_ip)){
  #   cat("...")
  #   new_ip <- get_current_ip()
  #   trig <- trig + 1
  #   Sys.sleep(1)
  # }
  
  if(current_ip == get_current_ip()){
    disconnect()
    cat("\n")
    message("Connexion could not be established")
  } else {
    message(glue("Connexion Successfull\n New IP: { new_ip }"))
  }
}

openvpn_config(server, intern = F)

get_current_ip()

disconnect()

server_list %>% View

```


```{r}
server_list <- update_server_list()

server_list %>%
  count(country_long, sort = T)

country <- "Mexico"
server <- server_country

connect_to <- function(country){
  server_country <- server_list %>%
    filter(country_long == country) %>%
    sample_n(1)
  
  get_config_file(server_country)
  
  openvpn_config(server_country, intern = F)
}

R.utils::withTimeout()

connect_to(country)
```



```{r}
server_list <- update_server_list()

server <- server_list %>%
  sample_n(1)

server %>%
  glimpse

get_config_file(server)

get_current_ip()

openvpn_config(server, intern = F)

get_current_ip()

disconnect()

server_list %>%
  count(country_long)

connect_to("Germany")
```

## Tunnelblick VPN

+ Copy the content of the vpn file to a given repository in text vile named my_vpn_profile.ovpn
+ add a file my_vpn_profile_password.txt
+ in the config file uncomment the line auth-user-pass and add behind it the full path of my_vpn_profile_password.txt

```{r}
#save(server_list, file = "data/server_list.Rdata")

connect_config_perso <- function(config_path){
  disconnect(2)
  
  if(!fs::file_exists(config_path)) stop("No config file, please check the path to the configuration file")
  
  config_path <- config_path %>%
    str_replace_all(" ", "\\\\ ")
  
  
  
  current_ip <- get_current_ip()
  message(glue("Current IP: { current_ip }"))
  
  system(paste0("sudo /usr/local/sbin/openvpn --config ",
                config_path), 
         ignore.stdout = F, ignore.stderr = F, 
         intern = intern, wait = F)
  
  run_as_long_as(
    expr = {cat(".") ; Sys.sleep(1)}, 
    output_cond = current_ip != get_current_ip(),
    max_iter = 30
  )
  
  if(current_ip == get_current_ip()){
    disconnect()
    cat("\n")
    message("Connexion could not be established")
  } else {
    message(glue("Connexion Successfull\n New IP: { new_ip }"))
  }
}

config_path <- "~/.vpn/utorvpn.ovpn"
get_current_ip()
connect_config_perso



```

# R6 Object

```{r}
read_lines(config_path)
config_path <- "~/.vpn/utorvpn.ovpn"
vpn <- vpn_tunnel$new(config_path = config_path)




test <- vpn_tunnel$new(config_file = config_file)
test$id
config_path <- test$config_path
test$connect(authentification = F)

disconnect()
```

```{r}

connect_vpn_gate_server <- function(server){
  config_file <- server$config_string  %>%
    pull(config_string) %>%
    str_split("\r|\n") %>%
    .[[1]] %>%
    discard(~.x == "")
  
  tunnel <- vpn_tunnel$new(config_file = config_file)
  
  tunnel$connect(authentification = F)
  
  return(tunnel)
}

server <- server_list_ %>%
  sample_n(1)

connect_vpn_gate_server()

```


# Trash

```{r}
configurations <- "dev tun
proto udp
remote vpn674350142.opengw.net 1459
;http-proxy-retry
;http-proxy [proxy server] [proxy port]
cipher AES-128-CBC
auth SHA1
resolv-retry infinite
nobind
persist-key
persist-tun
client
verb 3

<ca>
-----BEGIN CERTIFICATE-----
MIIF2DCCA8CgAwIBAgIQTKr5yttjb+Af907YWwOGnTANBgkqhkiG9w0BAQwFADCB
hTELMAkGA1UEBhMCR0IxGzAZBgNVBAgTEkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4G
A1UEBxMHU2FsZm9yZDEaMBgGA1UEChMRQ09NT0RPIENBIExpbWl0ZWQxKzApBgNV
BAMTIkNPTU9ETyBSU0EgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkwHhcNMTAwMTE5
MDAwMDAwWhcNMzgwMTE4MjM1OTU5WjCBhTELMAkGA1UEBhMCR0IxGzAZBgNVBAgT
EkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4GA1UEBxMHU2FsZm9yZDEaMBgGA1UEChMR
Q09NT0RPIENBIExpbWl0ZWQxKzApBgNVBAMTIkNPTU9ETyBSU0EgQ2VydGlmaWNh
dGlvbiBBdXRob3JpdHkwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCR
6FSS0gpWsawNJN3Fz0RndJkrN6N9I3AAcbxT38T6KhKPS38QVr2fcHK3YX/JSw8X
pz3jsARh7v8Rl8f0hj4K+j5c+ZPmNHrZFGvnnLOFoIJ6dq9xkNfs/Q36nGz637CC
9BR++b7Epi9Pf5l/tfxnQ3K9DADWietrLNPtj5gcFKt+5eNu/Nio5JIk2kNrYrhV
/erBvGy2i/MOjZrkm2xpmfh4SDBF1a3hDTxFYPwyllEnvGfDyi62a+pGx8cgoLEf
Zd5ICLqkTqnyg0Y3hOvozIFIQ2dOciqbXL1MGyiKXCJ7tKuY2e7gUYPDCUZObT6Z
+pUX2nwzV0E8jVHtC7ZcryxjGt9XyD+86V3Em69FmeKjWiS0uqlWPc9vqv9JWL7w
qP/0uK3pN/u6uPQLOvnoQ0IeidiEyxPx2bvhiWC4jChWrBQdnArncevPDt09qZah
SL0896+1DSJMwBGB7FY79tOi4lu3sgQiUpWAk2nojkxl8ZEDLXB0AuqLZxUpaVIC
u9ffUGpVRr+goyhhf3DQw6KqLCGqR84onAZFdr+CGCe01a60y1Dma/RMhnEw6abf
Fobg2P9A3fvQQoh/ozM6LlweQRGBY84YcWsr7KaKtzFcOmpH4MN5WdYgGq/yapiq
crxXStJLnbsQ/LBMQeXtHT1eKJ2czL+zUdqnR+WEUwIDAQABo0IwQDAdBgNVHQ4E
FgQUu69+Aj36pvE8hI6t7jiY7NkyMtQwDgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB
/wQFMAMBAf8wDQYJKoZIhvcNAQEMBQADggIBAArx1UaEt65Ru2yyTUEUAJNMnMvl
wFTPoCWOAvn9sKIN9SCYPBMtrFaisNZ+EZLpLrqeLppysb0ZRGxhNaKatBYSaVqM
4dc+pBroLwP0rmEdEBsqpIt6xf4FpuHA1sj+nq6PK7o9mfjYcwlYRm6mnPTXJ9OV
2jeDchzTc+CiR5kDOF3VSXkAKRzH7JsgHAckaVd4sjn8OoSgtZx8jb8uk2Intzna
FxiuvTwJaP+EmzzV1gsD41eeFPfR60/IvYcjt7ZJQ3mFXLrrkguhxuhoqEwWsRqZ
CuhTLJK7oQkYdQxlqHvLI7cawiiFwxv/0Cti76R7CZGYZ4wUAc1oBmpjIXUDgIiK
boHGhfKppC3n9KUkEEeDys30jXlYsQab5xoq2Z0B15R97QNKyvDb6KkBPvVWmcke
jkk9u+UJueBPSZI9FoJAzMxZxuY67RIuaTxslbH9qh17f4a+Hg4yRvv7E491f0yL
S0Zj/gA0QHDBw7mh3aZw4gSzQbzpgJHqZJx64SIDqZxubw5lT2yHh17zbqD5daWb
QOhTsiedSrnAdyGN/4fy3ryM7xfft0kL0fJuMAsaDk527RH89elWsn2/x20Kk4yl
0MC2Hb46TpSi125sC8KKfPog88Tk5c0NqMuRkrF8hey1FGlmDoLnzc7ILaZRfyHB
NVOFBkpdn627G190
-----END CERTIFICATE-----

</ca>

<cert>
-----BEGIN CERTIFICATE-----
MIICxjCCAa4CAQAwDQYJKoZIhvcNAQEFBQAwKTEaMBgGA1UEAxMRVlBOR2F0ZUNs
aWVudENlcnQxCzAJBgNVBAYTAkpQMB4XDTEzMDIxMTAzNDk0OVoXDTM3MDExOTAz
MTQwN1owKTEaMBgGA1UEAxMRVlBOR2F0ZUNsaWVudENlcnQxCzAJBgNVBAYTAkpQ
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5h2lgQQYUjwoKYJbzVZA
5VcIGd5otPc/qZRMt0KItCFA0s9RwReNVa9fDRFLRBhcITOlv3FBcW3E8h1Us7RD
4W8GmJe8zapJnLsD39OSMRCzZJnczW4OCH1PZRZWKqDtjlNca9AF8a65jTmlDxCQ
CjntLIWk5OLLVkFt9/tScc1GDtci55ofhaNAYMPiH7V8+1g66pGHXAoWK6AQVH67
XCKJnGB5nlQ+HsMYPV/O49Ld91ZN/2tHkcaLLyNtywxVPRSsRh480jju0fcCsv6h
p/0yXnTB//mWutBGpdUlIbwiITbAmrsbYnjigRvnPqX1RNJUbi9Fp6C2c/HIFJGD
ywIDAQABMA0GCSqGSIb3DQEBBQUAA4IBAQChO5hgcw/4oWfoEFLu9kBa1B//kxH8
hQkChVNn8BRC7Y0URQitPl3DKEed9URBDdg2KOAz77bb6ENPiliD+a38UJHIRMqe
UBHhllOHIzvDhHFbaovALBQceeBzdkQxsKQESKmQmR832950UCovoyRB61UyAV7h
+mZhYPGRKXKSJI6s0Egg/Cri+Cwk4bjJfrb5hVse11yh4D9MHhwSfCOH+0z4hPUT
Fku7dGavURO5SVxMn/sL6En5D+oSeXkadHpDs+Airym2YHh15h0+jPSOoR6yiVp/
6zZeZkrN43kuS73KpKDFjfFPh8t4r1gOIjttkNcQqBccusnplQ7HJpsk
-----END CERTIFICATE-----

</cert>

<key>
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA5h2lgQQYUjwoKYJbzVZA5VcIGd5otPc/qZRMt0KItCFA0s9R
wReNVa9fDRFLRBhcITOlv3FBcW3E8h1Us7RD4W8GmJe8zapJnLsD39OSMRCzZJnc
zW4OCH1PZRZWKqDtjlNca9AF8a65jTmlDxCQCjntLIWk5OLLVkFt9/tScc1GDtci
55ofhaNAYMPiH7V8+1g66pGHXAoWK6AQVH67XCKJnGB5nlQ+HsMYPV/O49Ld91ZN
/2tHkcaLLyNtywxVPRSsRh480jju0fcCsv6hp/0yXnTB//mWutBGpdUlIbwiITbA
mrsbYnjigRvnPqX1RNJUbi9Fp6C2c/HIFJGDywIDAQABAoIBAERV7X5AvxA8uRiK
k8SIpsD0dX1pJOMIwakUVyvc4EfN0DhKRNb4rYoSiEGTLyzLpyBc/A28Dlkm5eOY
fjzXfYkGtYi/Ftxkg3O9vcrMQ4+6i+uGHaIL2rL+s4MrfO8v1xv6+Wky33EEGCou
QiwVGRFQXnRoQ62NBCFbUNLhmXwdj1akZzLU4p5R4zA3QhdxwEIatVLt0+7owLQ3
lP8sfXhppPOXjTqMD4QkYwzPAa8/zF7acn4kryrUP7Q6PAfd0zEVqNy9ZCZ9ffho
zXedFj486IFoc5gnTp2N6jsnVj4LCGIhlVHlYGozKKFqJcQVGsHCqq1oz2zjW6LS
oRYIHgECgYEA8zZrkCwNYSXJuODJ3m/hOLVxcxgJuwXoiErWd0E42vPanjjVMhnt
KY5l8qGMJ6FhK9LYx2qCrf/E0XtUAZ2wVq3ORTyGnsMWre9tLYs55X+ZN10Tc75z
4hacbU0hqKN1HiDmsMRY3/2NaZHoy7MKnwJJBaG48l9CCTlVwMHocIECgYEA8jby
dGjxTH+6XHWNizb5SRbZxAnyEeJeRwTMh0gGzwGPpH/sZYGzyu0SySXWCnZh3Rgq
5uLlNxtrXrljZlyi2nQdQgsq2YrWUs0+zgU+22uQsZpSAftmhVrtvet6MjVjbByY
DADciEVUdJYIXk+qnFUJyeroLIkTj7WYKZ6RjksCgYBoCFIwRDeg42oK89RFmnOr
LymNAq4+2oMhsWlVb4ejWIWeAk9nc+GXUfrXszRhS01mUnU5r5ygUvRcarV/T3U7
TnMZ+I7Y4DgWRIDd51znhxIBtYV5j/C/t85HjqOkH+8b6RTkbchaX3mau7fpUfds
Fq0nhIq42fhEO8srfYYwgQKBgQCyhi1N/8taRwpk+3/IDEzQwjbfdzUkWWSDk9Xs
H/pkuRHWfTMP3flWqEYgW/LW40peW2HDq5imdV8+AgZxe/XMbaji9Lgwf1RY005n
KxaZQz7yqHupWlLGF68DPHxkZVVSagDnV/sztWX6SFsCqFVnxIXifXGC4cW5Nm9g
va8q4QKBgQCEhLVeUfdwKvkZ94g/GFz731Z2hrdVhgMZaU/u6t0V95+YezPNCQZB
wmE9Mmlbq1emDeROivjCfoGhR3kZXW1pTKlLh6ZMUQUOpptdXva8XxfoqQwa3enA
M7muBbF0XN7VO80iJPv+PmIZdEIAkpwKfi201YB+BafCIuGxIF50Vg==
-----END RSA PRIVATE KEY-----

</key>"
```


```{r}



server <- server_country

get_config_file <- function(server, force = F){
  
  config_file <- get_config_path(server$number_host_name)
  
  if(fs::file_exists(config_file) & !force) {
    message("Config file already exists")
    
  } else {
    page_tmp <- run_as_long_as(
      output_cond = class(out)[1] == "character",
      expr = server$config_link %>% read_html, 
      max_iter = 5,
      time_out = 10, 
      quiet = F
    )
    
    if(is.null(page_tmp)) stop("Config File could not be retrieved")
    # page_tmp <- ""
    # trig <- 1
    # 
    # while(!(class(page_tmp)[1] != "character" & trig > 4)){
    #   page_tmp <- R.utils::withTimeout({
    #     try({
    #       server$config_link %>% read_html
    #     })
    #   }, timeout = 10, onTimeout = "warning")
    #   if(class(page_tmp)[1] == "try-error") page_tmp <- ""
    #   trig <- trig + 1
    #   
    #   if(trig != 4) message("Trying Again...")
    #   if(trig == 4) message("Last Iteration")
    # }
    # 
    # if(class(page_tmp)[1] %in% c("character", "try-error") | is.null(page_tmp)){
    #   stop("Config file could not be retrieved")
    # }
    
    file_link <- page_tmp %>%
      html_nodes("a strong") %>%
      map_chr(get_openvpn_config_link) %>%
      paste0("https://www.vpngate.net", .) %>%
      keep(str_detect, "host=vpn") %>%
      .[1]
    
    run_as_long_as(
      expr = download.file(file_link, config_file), 
      max_iter = 5, 
      time_out = 10
    )
    
    message(glue("Config successfully savec un { config_file }"))
  }
  
}

configurations <- read_lines(config_path) %>%
  discard(~.x %>% str_detect("^#")) %>%
  discard(~.x == "") %>%
  paste(.,  collapse = "\n")


get_config_file(server)

```
